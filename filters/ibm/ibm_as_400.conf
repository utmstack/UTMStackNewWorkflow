filter {

# IBM AS 400 filter version 2.0.1
# Support Syslog CEF and LEEF format, and Java Agent Syslog messsages
# Based on https://docs.centrify.com/Content/IntegrationContent/SIEM/arcsight-cef/arcsight-cef-format.htm (may 2022)
# https://www.ibm.com/docs/en/dsm?topic=leef-overview (may 2022)
# https://www.ibm.com/docs/en/dsm?topic=overview-leef-event-components (may 2022)
# https://www.ibm.com/docs/en/dsm?topic=overview-predefined-leef-event-attributes (may 2022)
# LEEF:Version|Vendor|Product|Version|EventID|(DelimiterCharacter) disponible en 2.0|
# LEEF:1.0|Microsoft|MSExchange|4.0 SP1|15345|
# LEEF:2.0|Lancope|StealthWatch|1.0|41|x5E|

    split {
      field => "message"
      terminator => "<utm-log-separator>"
    }

    #Looking for datasource generated by an agent and parse original message
    if [message]=~/\[utm_stack_collector_ds=(.+)\]-(.+)/ {
      grok {
       match => {
          "message" => [ "\[utm_stack_collector_ds=%{DATA:dataSourceCollector}\]-%{GREEDYDATA:original_log_message}" ]
        }
      }
    }
    if [original_log_message] {
      mutate {
        update => { "message" => "%{[original_log_message]}" }
      }
    }

  if ![dataType] {
#......................................................................#
#Generating dataSource field required by CurrelationRulesEngine
#Checks if exists, if not evaluate to the host variable
            if (![dataSource]){
              if ([dataSourceCollector]){
                mutate {
                    rename => { "[dataSourceCollector]" => "[dataSource]" }
                }
              } else {
                mutate {
                    add_field => { "dataSource" => "%{host}" }
                }
              }
            }
           if (![dataSource]){
              mutate {
               add_field => { "dataSource" => "%{host}" }
              }
           }
#......................................................................# 
#Generating dataType field required by CurrelationRulesEngine
          mutate {
            add_field => { "dataType" => "ibm-as400" }
          }
#First, search to define the entry point contain CEF: or LEEF:, contain |something, or look for IBM
    if [message] and ( (("CEF:" in [message] or "LEEF:" in [message]) and [message] =~/\|(\w+)?(\s)?IBM(\s)?(\w+)?\|/ ) or [message] =~/(\w+)?(\s)IBM(\s)(\w+)?/ ) {
#......................................................................#
#If CEF or LEEF formatted log do the parsing of the message mark as undefined syslog format
        if ("CEF:" in [message] or "LEEF:" in [message] ) {
#......................................................................#
#Using grok to parse header of the message
            grok {
              match => {
                "message" => [
                   "(\[DEVICE_TYPE=AS400, LOG_GEN_COLLECTOR=UTMStack\](\s))?(%{INT:not_defined})?(\s)?(<%{NUMBER:priority}>)?(%{INT:syslog_version})?((\s)%{GREEDYDATA:syslog_date_host}(\s))?(?<format_type>(CEF|LEEF)):(\s)?(?<format_version>(%{INT}\.%{INT}|%{INT}))%{GREEDYDATA:cef_or_leef_msg_all}"
                ]
              }
            }
        }
        if ("CEF:" in [message] ) {
#......................................................................#
#Using grok to parse components of the cef_message
          if [cef_or_leef_msg_all] {  
            grok {
              match => {
                "cef_or_leef_msg_all" => [
                   "\|%{DATA:embDeviceVendor}\|%{DATA:embDeviceProduct}\|%{DATA:embDeviceVersion}\|%{DATA:signatureID}\|%{DATA:act_msg}\|%{DATA:severity}\|%{GREEDYDATA:cef_or_leef_msg}",
                   "\|%{DATA:embDeviceVendor}\|%{DATA:embDeviceProduct}\|%{DATA:signatureID}\|%{DATA:act_msg}\|%{DATA:severity}\|%{GREEDYDATA:cef_or_leef_msg}",
                   "\|%{DATA:embDeviceVendor}\|%{DATA:embDeviceProduct}\|%{GREEDYDATA:cef_or_leef_msg}"
                ]
              }
            }
          }
        } else if ("LEEF:" in [message] ) {
#......................................................................#
#Using grok to parse components of the leef_message
          if [cef_or_leef_msg_all] {  
            grok {
              match => {
                "cef_or_leef_msg_all" => [
                   "\|%{DATA:embDeviceVendor}\|%{DATA:embDeviceProduct}\|%{DATA:embDeviceVersion}\|%{DATA:eventID}\|%{DATA:DelimiterCharacter}\|%{GREEDYDATA:cef_or_leef_msg}",
                   "\|%{DATA:embDeviceVendor}\|%{DATA:embDeviceProduct}\|%{DATA:eventID}\|%{DATA:DelimiterCharacter}\|%{GREEDYDATA:cef_or_leef_msg}",
                   "\|%{DATA:embDeviceVendor}\|%{DATA:embDeviceProduct}\|%{GREEDYDATA:cef_or_leef_msg}"
                ]
              }
            }
          }
        }
#......................................................................# 
#First, replace whitespaces with default string after = to avoid kv issues, example:
#gattServices= manufacturerName=MFN, generates -> gattServices="manufacturerName=MFN"
#and should generate two fields: gattServices and manufacturerName
    if [cef_or_leef_msg] {
      mutate {
        gsub => [
          "cef_or_leef_msg", "(\w+)= ", "\1=X0X "
        ]
      }
#......................................................................#
#Using the kv filter with default config, usefull in key-value logs
      kv { 
        source => "cef_or_leef_msg" 
        allow_duplicate_values => false
        target => "kv_field"
      }
    }
#......................................................................#
#Remove fields that have issues with kv filter (spaces or = in value)
#then generate them by parsing, filtered by CEF and LEEF format
#......................................................................#
    if [kv_field] {
       mutate {
         remove_field => ["[kv_field][rt]","[kv_field][destinationZoneURI]","[kv_field][msg]",
         "[kv_field][customerURI]","[kv_field][destinationZoneExternalID]","[kv_field][cs1]",
         "[kv_field][cs2]","[kv_field][cs3]","[kv_field][cs4]","[kv_field][cs5]","[kv_field][cs6]",
         "[kv_field][originalAgentZoneURI]","[kv_field][flexString1]","[kv_field][cat]",
         "[kv_field][cs1Label]","[kv_field][cs2Label]","[kv_field][cs3Label]","[kv_field][cs4Label]",
         "[kv_field][cs5Label]","[kv_field][cs6Label]","[kv_field][cn1]","[kv_field][cn2]",
         "[kv_field][cn3]","[kv_field][cn4]","[kv_field][cn5]","[kv_field][cn6]","[kv_field][cn1Label]",
         "[kv_field][cn2Label]","[kv_field][cn3Label]","[kv_field][cn4Label]","[kv_field][cn5Label]",
         "[kv_field][cn6Label]","[kv_field][suser]","[kv_field][ruleName]","[kv_field][duser]",
         "[kv_field][accountName]","[kv_field][eventDesc]","[kv_field][endpointDeviceControlDeviceName]",
         "[kv_field][sourceAgentLastActivityTimestamp]","[kv_field][sourceAgentRegisterTimestamp]",
         "[kv_field][manufacturerName]","[kv_field][sourceUserName]","[kv_field][sourceGroupName]",
         "[kv_field][siteName]","[kv_field][deviceRuleType]","[kv_field][reason]","[kv_field][identHostName]",
         "[kv_field][identNetBios]","[kv_field][identGrpName]","[kv_field][vSrcName]","[kv_field][role]",
         "[kv_field][realm]","[kv_field][policy]","[kv_field][resource]","[kv_field][url]",
         "[kv_field][usrName]","[kv_field][filePath]","[kv_field][changedData]",
         "[kv_field][pgmName]","[kv_field][memberName]","[kv_field][rowData]",
         "[kv_field][updatedColumnNames]","[kv_field][rowDataBefore]","[kv_field][rowDataAfter]"]
       }
    }
#......................................................................#
#Using grok to parse kv issued fields
    if [cef_or_leef_msg] {
       grok { match => { "cef_or_leef_msg" => ["rt=%{DATA:rt} %{WORD}=","rt=%{GREEDYDATA:rt}"] } }
       grok { match => { "cef_or_leef_msg" => ["pgmName=%{DATA:pgmName} %{WORD}=","pgmName=%{GREEDYDATA:pgmName}"] } }
       grok { match => { "cef_or_leef_msg" => ["memberName=%{DATA:memberName} %{WORD}=","memberName=%{GREEDYDATA:memberName}"] } }
       grok { match => { "cef_or_leef_msg" => ["rowData=%{DATA:rowData} %{WORD}=","rowData=%{GREEDYDATA:rowData}"] } }
       grok { match => { "cef_or_leef_msg" => ["updatedColumnNames=%{DATA:updatedColumnNames} %{WORD}=","updatedColumnNames=%{GREEDYDATA:updatedColumnNames}"] } }
       grok { match => { "cef_or_leef_msg" => ["rowDataBefore=%{DATA:rowDataBefore} %{WORD}=","rowDataBefore=%{GREEDYDATA:rowDataBefore}"] } }
       grok { match => { "cef_or_leef_msg" => ["rowDataAfter=%{DATA:rowDataAfter} %{WORD}=","rowDataAfter=%{GREEDYDATA:rowDataAfter}"] } }
       grok { match => { "cef_or_leef_msg" => ["destinationZoneURI=%{DATA:destinationZoneURI} %{WORD}=","destinationZoneURI=%{GREEDYDATA:destinationZoneURI}"] } }
       grok { match => { "cef_or_leef_msg" => ["msg=%{DATA:msg} %{WORD}=","msg=%{GREEDYDATA:msg}"] } }
       grok { match => { "cef_or_leef_msg" => ["customerURI=%{DATA:customerURI} %{WORD}=","customerURI=%{GREEDYDATA:customerURI}"] } }
       grok { match => { "cef_or_leef_msg" => ["destinationZoneExternalID=%{DATA:destinationZoneExternalID} %{WORD}=","destinationZoneExternalID=%{GREEDYDATA:destinationZoneExternalID}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs1=%{DATA:cs1} %{WORD}=","cs1=%{GREEDYDATA:cs1}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs2=%{DATA:cs2} %{WORD}=","cs2=%{GREEDYDATA:cs2}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs3=%{DATA:cs3} %{WORD}=","cs3=%{GREEDYDATA:cs3}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs4=%{DATA:cs4} %{WORD}=","cs4=%{GREEDYDATA:cs4}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs5=%{DATA:cs5} %{WORD}=","cs5=%{GREEDYDATA:cs5}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs6=%{DATA:cs6} %{WORD}=","cs6=%{GREEDYDATA:cs6}"] } }
       grok { match => { "cef_or_leef_msg" => ["originalAgentZoneURI=%{DATA:originalAgentZoneURI} %{WORD}=","originalAgentZoneURI=%{GREEDYDATA:originalAgentZoneURI}"] } }
       grok { match => { "cef_or_leef_msg" => ["flexString1=%{DATA:flexString1} %{WORD}=","flexString1=%{GREEDYDATA:flexString1}"] } }
       grok { match => { "cef_or_leef_msg" => ["cat=%{DATA:cat} %{WORD}=","cat=%{GREEDYDATA:cat}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs1Label=%{DATA:cs1Label} %{WORD}=","cs1Label=%{GREEDYDATA:cs1Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs2Label=%{DATA:cs2Label} %{WORD}=","cs2Label=%{GREEDYDATA:cs2Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs3Label=%{DATA:cs3Label} %{WORD}=","cs3Label=%{GREEDYDATA:cs3Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs4Label=%{DATA:cs4Label} %{WORD}=","cs4Label=%{GREEDYDATA:cs4Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs5Label=%{DATA:cs5Label} %{WORD}=","cs5Label=%{GREEDYDATA:cs5Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cs6Label=%{DATA:cs6Label} %{WORD}=","cs6Label=%{GREEDYDATA:cs6Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn1=%{DATA:cn1} %{WORD}=","cn1=%{GREEDYDATA:cn1}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn2=%{DATA:cn2} %{WORD}=","cn2=%{GREEDYDATA:cn2}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn3=%{DATA:cn3} %{WORD}=","cn3=%{GREEDYDATA:cn3}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn4=%{DATA:cn4} %{WORD}=","cn4=%{GREEDYDATA:cn4}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn5=%{DATA:cn5} %{WORD}=","cn5=%{GREEDYDATA:cn5}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn6=%{DATA:cn6} %{WORD}=","cn6=%{GREEDYDATA:cn6}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn1Label=%{DATA:cn1Label} %{WORD}=","cn1Label=%{GREEDYDATA:cn1Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn2Label=%{DATA:cn2Label} %{WORD}=","cn2Label=%{GREEDYDATA:cn2Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn3Label=%{DATA:cn3Label} %{WORD}=","cn3Label=%{GREEDYDATA:cn3Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn4Label=%{DATA:cn4Label} %{WORD}=","cn4Label=%{GREEDYDATA:cn4Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn5Label=%{DATA:cn5Label} %{WORD}=","cn5Label=%{GREEDYDATA:cn5Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["cn6Label=%{DATA:cn6Label} %{WORD}=","cn6Label=%{GREEDYDATA:cn6Label}"] } }
       grok { match => { "cef_or_leef_msg" => ["suser=%{DATA:suser} %{WORD}=","suser=%{GREEDYDATA:suser}"] } }
       grok { match => { "cef_or_leef_msg" => ["ruleName=%{DATA:ruleName} %{WORD}=","ruleName=%{GREEDYDATA:ruleName}"] } }
       grok { match => { "cef_or_leef_msg" => ["duser=%{DATA:duser} %{WORD}=","duser=%{GREEDYDATA:duser}"] } }
       grok { match => { "cef_or_leef_msg" => ["accountName=%{DATA:accountName} %{WORD}="] } }
       grok { match => { "cef_or_leef_msg" => ["eventDesc=%{DATA:eventDesc} %{WORD}=","eventDesc=%{GREEDYDATA:eventDesc}"] } }
       grok { match => { "cef_or_leef_msg" => ["endpointDeviceControlDeviceName=%{DATA:endpointDeviceControlDeviceName} %{WORD}=","endpointDeviceControlDeviceName=%{GREEDYDATA:endpointDeviceControlDeviceName}"] } }
       grok { match => { "cef_or_leef_msg" => ["sourceAgentLastActivityTimestamp=%{DATA:sourceAgentLastActivityTimestamp} %{WORD}=","sourceAgentLastActivityTimestamp=%{GREEDYDATA:sourceAgentLastActivityTimestamp}"] } }
       grok { match => { "cef_or_leef_msg" => ["sourceAgentRegisterTimestamp=%{DATA:sourceAgentRegisterTimestamp} %{WORD}=","sourceAgentRegisterTimestamp=%{GREEDYDATA:sourceAgentRegisterTimestamp}"] } }
       grok { match => { "cef_or_leef_msg" => ["manufacturerName=%{DATA:manufacturerName} %{WORD}=","manufacturerName=%{GREEDYDATA:manufacturerName}"] } }
       grok { match => { "cef_or_leef_msg" => ["sourceUserName=%{DATA:sourceUserName} %{WORD}=","sourceUserName=%{GREEDYDATA:sourceUserName}"] } }
       grok { match => { "cef_or_leef_msg" => ["sourceGroupName=%{DATA:sourceGroupName} %{WORD}=","sourceGroupName=%{GREEDYDATA:sourceGroupName}"] } }
       grok { match => { "cef_or_leef_msg" => ["siteName=%{DATA:siteName} %{WORD}=","siteName=%{GREEDYDATA:siteName}"] } }
       grok { match => { "cef_or_leef_msg" => ["deviceRuleType=%{DATA:deviceRuleType} %{WORD}=","deviceRuleType=%{GREEDYDATA:deviceRuleType}"] } }
       grok { match => { "cef_or_leef_msg" => ["reason=%{DATA:reason} %{WORD}=","reason=%{GREEDYDATA:reason}"] } }
       grok { match => { "cef_or_leef_msg" => ["identHostName=%{DATA:identHostName} %{WORD}=","identHostName=%{GREEDYDATA:identHostName}"] } }
       grok { match => { "cef_or_leef_msg" => ["identNetBios=%{DATA:identNetBios} %{WORD}=","identNetBios=%{GREEDYDATA:identNetBios}"] } }
       grok { match => { "cef_or_leef_msg" => ["identGrpName=%{DATA:identGrpName} %{WORD}=","identGrpName=%{GREEDYDATA:identGrpName}"] } }
       grok { match => { "cef_or_leef_msg" => ["vSrcName=%{DATA:vSrcName} %{WORD}=","vSrcName=%{GREEDYDATA:vSrcName}"] } }
       grok { match => { "cef_or_leef_msg" => ["role=%{DATA:role} %{WORD}=","role=%{GREEDYDATA:role}"] } }
       grok { match => { "cef_or_leef_msg" => ["realm=%{DATA:realm} %{WORD}=","realm=%{GREEDYDATA:realm}"] } }
       grok { match => { "cef_or_leef_msg" => ["policy=%{DATA:policy} %{WORD}=","policy=%{GREEDYDATA:policy}"] } }
       grok { match => { "cef_or_leef_msg" => ["resource=%{DATA:resource} %{WORD}=","resource=%{GREEDYDATA:resource}"] } }
       grok { match => { "cef_or_leef_msg" => ["url=%{DATA:url} %{WORD}=","url=%{GREEDYDATA:url}"] } }
       grok { match => { "cef_or_leef_msg" => ["usrName=%{DATA:usrName} %{WORD}=","usrName=%{GREEDYDATA:usrName}"] } }
       grok { match => { "cef_or_leef_msg" => ["filePath=%{DATA:filePath} %{WORD}=","filePath=%{GREEDYDATA:filePath}"] } }
       grok { match => { "cef_or_leef_msg" => ["changedData=%{DATA:changedData} %{WORD}=","changedData=%{GREEDYDATA:changedData}"] } }
    }
       mutate {
         #Rename fields with kv issues (individual groks)
          rename => { "[pgmName]" => "[kv_field][pgmName]" }
          rename => { "[memberName]" => "[kv_field][memberName]" }
          rename => { "[rowData]" => "[kv_field][rowData]" }
          rename => { "[updatedColumnNames]" => "[kv_field][updatedColumnNames]" }
          rename => { "[rowDataBefore]" => "[kv_field][rowDataBefore]" }
          rename => { "[rowDataAfter]" => "[kv_field][rowDataAfter]" }
          rename => { "[cs1]" => "[kv_field][cs1]" }
          rename => { "[cs2]" => "[kv_field][cs2]" }
          rename => { "[cs3]" => "[kv_field][cs3]" }
          rename => { "[cs4]" => "[kv_field][cs4]" }
          rename => { "[cs5]" => "[kv_field][cs5]" }
          rename => { "[cs6]" => "[kv_field][cs6]" }
          rename => { "[cs1Label]" => "[kv_field][cs1Label]" }
          rename => { "[cs2Label]" => "[kv_field][cs2Label]" }
          rename => { "[cs3Label]" => "[kv_field][cs3Label]" }
          rename => { "[cs4Label]" => "[kv_field][cs4Label]" }
          rename => { "[cs5Label]" => "[kv_field][cs5Label]" }
          rename => { "[cs6Label]" => "[kv_field][cs6Label]" }
          rename => { "[cn1]" => "[kv_field][cn1]" }
          rename => { "[cn2]" => "[kv_field][cn2]" }
          rename => { "[cn3]" => "[kv_field][cn3]" }
          rename => { "[cn4]" => "[kv_field][cn4]" }
          rename => { "[cn5]" => "[kv_field][cn5]" }
          rename => { "[cn6]" => "[kv_field][cn6]" }
          rename => { "[cn1Label]" => "[kv_field][cn1Label]" }
          rename => { "[cn2Label]" => "[kv_field][cn2Label]" }
          rename => { "[cn3Label]" => "[kv_field][cn3Label]" }
          rename => { "[cn4Label]" => "[kv_field][cn4Label]" }
          rename => { "[cn5Label]" => "[kv_field][cn5Label]" }
          rename => { "[cn6Label]" => "[kv_field][cn6Label]" }
          rename => { "[msg]" => "[kv_field][msg]" }
          rename => { "[customerURI]" => "[kv_field][customerURI]" }
          rename => { "[cat]" => "[kv_field][cat]" }
          rename => { "[rt]" => "[kv_field][rt]" }
          rename => { "[destinationZoneURI]" => "[kv_field][destinationZoneURI]" }
          rename => { "[destinationZoneExternalID]" => "[kv_field][destinationZoneExternalID]" }
          rename => { "[message]" => "[kv_field][message]" }
          rename => { "[duser]" => "[kv_field][duser]" }
          rename => { "[suser]" => "[kv_field][suser]" }
          rename => { "[originalAgentZoneURI]" => "[kv_field][originalAgentZoneURI]" }
          rename => { "[flexString1]" => "[kv_field][flexString1]" }
          rename => { "[ruleName]" => "[kv_field][ruleName]" }
          rename => { "[accountName]" => "[kv_field][accountName]" }
          rename => { "[eventDesc]" => "[kv_field][eventDesc]" }
          rename => { "[endpointDeviceControlDeviceName]" => "[kv_field][endpointDeviceControlDeviceName]" }
          rename => { "[sourceAgentLastActivityTimestamp]" => "[kv_field][sourceAgentLastActivityTimestamp]" }
          rename => { "[sourceAgentRegisterTimestamp]" => "[kv_field][sourceAgentRegisterTimestamp]" }
          rename => { "[manufacturerName]" => "[kv_field][manufacturerName]" }
          rename => { "[sourceUserName]" => "[kv_field][sourceUserName]" }
          rename => { "[sourceGroupName]" => "[kv_field][sourceGroupName]" }
          rename => { "[siteName]" => "[kv_field][siteName]" }
          rename => { "[deviceRuleType]" => "[kv_field][deviceRuleType]" }
          rename => { "[reason]" => "[kv_field][reason]" }
          rename => { "[identHostName]" => "[kv_field][identHostName]" }
          rename => { "[identNetBios]" => "[kv_field][identNetBios]" }
          rename => { "[identGrpName]" => "[kv_field][identGrpName]" }
          rename => { "[vSrcName]" => "[kv_field][vSrcName]" }
          rename => { "[role]" => "[kv_field][role]" }
          rename => { "[realm]" => "[kv_field][realm]" }
          rename => { "[policy]" => "[kv_field][policy]" }
          rename => { "[resource]" => "[kv_field][resource]" }
          rename => { "[url]" => "[kv_field][url]" }
          rename => { "[usrName]" => "[kv_field][usrName]" }
          rename => { "[filePath]" => "[kv_field][filePath]" }
          rename => { "[changedData]" => "[kv_field][changedData]" }
       }
#......................................................................#
#Add fields to the tree structure
#......................................................................#
        mutate {
          #Rename the filds out of kv results
          rename => { "[signatureID]" => "[kv_field][signatureID]" }
          rename => { "[eventID]" => "[kv_field][eventID]" }
          rename => { "[embDeviceVendor]" => "[kv_field][embDeviceVendor]" }
          rename => { "[embDeviceProduct]" => "[kv_field][embDeviceProduct]" }
          rename => { "[act_msg]" => "[kv_field][act_msg]" }
          rename => { "[format_version]" => "[kv_field][format_version]" }
          rename => { "[embDeviceVersion]" => "[kv_field][embDeviceVersion]" }
          rename => { "[priority]" => "[kv_field][priority]" }
          rename => { "[severity]" => "[kv_field][severity]" }
          rename => { "[end_msg]" => "[kv_field][end_msg]" }
          rename => { "[format_type]" => "[kv_field][format_type]" }
          rename => { "[DelimiterCharacter]" => "[kv_field][DelimiterCharacter]" }
        }

#......................................................................#
#Correlation standard fields
#......................................................................#
    #src can be in multiple fields
    if [kv_field][src] {
        mutate {
          rename => { "[kv_field][src]" => "[kv_field][src_ip]" }
        }
    } else if ([kv_field][cs4Label]) and ("clientIp" in [kv_field][cs4Label]) {
        mutate {
          rename => { "[kv_field][cs4]" => "[kv_field][src_ip]" }
        }
    } else if [kv_field][FromIPAddress] {
        mutate {
          rename => { "[kv_field][FromIPAddress]" => "[kv_field][src_ip]" }
        }
    }

        mutate {
          rename => { "[kv_field][dst]" => "[kv_field][dest_ip]" }
          rename => { "[kv_field][srcPort]" => "[kv_field][src_port]" }
          rename => { "[kv_field][dstPort]" => "[kv_field][dest_port]" }
        }
#......................................................................#

#......................................................................#
#Set null the fields with de X0X value (default string for null), and replace simple and double quotation
#also generate logx tree structure dynamically
          if ([kv_field]) {
            ruby {
                code => '
                    event.get("[kv_field]").each do |k, v|
                          if (v == "X0X") 
                            event.set("[logx][ibm_as400][#{k}]",nil)
                          elsif (k=~/(\W)$/)
                              event.remove(k)
                          elsif !(v.kind_of?(Array))
                              new_v = v.to_s.gsub(/\"/, "")
                              new_v = new_v.gsub(/\'/, "")
                              event.set("[logx][ibm_as400][#{k}]",new_v)
                          else
                              event.set("[logx][ibm_as400][#{k}]",v)
                          end
                       end   
                    '
            }
          }
#......................................................................#
   #Finally, remove unnecessary fields
   mutate {
      remove_field => ["@version","path","tags","type","syslog_version","kv_field",
      "not_defined","cef_or_leef_msg_all","cef_or_leef_msg","syslog_date_host","irrelevant","init_msg"]
   }
  
#......................................................................#
# Java Agent Syslog filtering
#......................................................................#  
  } else if [message] and ( "[DEVICE_TYPE=AS400, LOG_GEN_COLLECTOR=UTMStack]" in [message] ) {
#......................................................................#
#Generating dataSource field required by CurrelationRulesEngine
#Checks if exists, if not evaluate to the host variable
           grok {
              match => {
                "message" => [
                   "\[DEVICE_TYPE=AS400, LOG_GEN_COLLECTOR=UTMStack\] %{GREEDYDATA:msg}"
                ]
              }
           }

#......................................................................#
#Then add all possible fields to the json tree structure
   mutate {
      remove_field => ["message"]
   }
   mutate { 
      rename => { "msg" => "[logx][ibm_as400][message]" }
   }
  }
#......................................................................#
#Finally, remove unnecessary fields
   mutate {
      remove_field => ["@version","path","tags","type","original_log_message","headers"]
   }
 }
}
