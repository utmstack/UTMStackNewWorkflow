<div class="vul-container container-fluid pr-3 pl-3 pt-2">
  <div class="d-flex justify-content-between align-items-center tab-header mb-2">
    <h5 class="card-title mb-0 text-uppercase label-header">
      Vulnerability tasks
    </h5>
    <button (click)="newTask()" class="btn utm-button utm-button-primary">
      <i class="icon-task mr-1"></i> New task
    </button>
  </div>
  <div class="d-flex flex-nowrap m-0 align-items-start">
    <div (resizeEnd)="onResize($event)"
         (resizing)="onResize($event)"
         [enableGhostResize]="true"
         [ngStyle]="{'width':filterWidth+'px'}"
         [resizeEdges]="{ bottom: false, right: true, top: false, left: false }"
         class="resizable-filter-container mr-2"
         mwlResizable>
      <div class="card h-100">
        <div class="card-header header-elements-sm-inline p-2 bg-white card-header-title">
          <label class="card-title">
            <app-utm-dtable-columns [fields]="fieldFilters"
                                    [label]="'filters'"
                                    [showInactive]="true"
                                    icon="icon-cog3">
            </app-utm-dtable-columns> &nbsp;Filters</label>
          <div class="d-flex">

            <span (click)="resetAllFilters()" class="ml-2 cursor-pointer text-blue-800 position-relative"
                  ngbTooltip="Reset filters"
                  placement="top" tooltipClass="utm-tooltip-top">
               <i class="icon-filter4"></i>
            </span>
          </div>
        </div>
        <div class="filter-container p-2 d-flex flex-column justify-content-start h-100 w-100">
          <div *ngFor="let filter of fieldFilters" class="w-100">
            <div *ngIf="filter.visible" class="w-100 mb-2">
              <app-vs-task-generic-filter (filterGenericChange)="onFilterChange($event)"
                                          [fieldFilter]="filter">
              </app-vs-task-generic-filter>
            </div>
          </div>
        </div>
      </div>

    </div>
    <div class="flex-grow-1">

      <div class="card h-100">
        <div [ngStyle]="{'max-width':tableWidth+'px'}"
             class="table-responsive resizable-table-responsive h-100">
          <div class="card-header p-2 w-100">
            <div class="d-flex justify-content-between align-items-center">
              <app-elastic-filter-time (timeFilterChange)="onTimeChange($event)"
                                       [changeOnInit]="'YES'"
                                       [formatInstant]="true"
                                       container="body"
                                       [invertContent]="true"
                                       [timeDefault]="defaultTime"></app-elastic-filter-time>


              <span (click)="viewSeverityHelp()" class="text-blue-800 cursor-pointer"
                    ngbTooltip="View severity info"
                    placement="left" tooltipClass="utm-tooltip">
                 <i class="icon-info22"></i>
              </span>

            </div>
          </div>
          <table class="table text-nowrap">
            <thead>
            <tr>
              <th (sort)="onSortBy($event)"
                  appColumnSortable
                  class="font-weight-semibold"
                  sortable="task_name"
                  style="width: 20%">
                Name&nbsp;
              </th>
              <th (sort)="onSortBy($event)" appColumnSortable
                  class="font-weight-semibold text-center"
                  sortable="task_status"
                  style="width: 12%">
                Status&nbsp;
              </th>
              <th (sort)="onSortBy($event)"
                  appColumnSortable
                  class="font-weight-semibold"
                  sortable="task_creation_time">
                Created at&nbsp;
              </th>
              <th (sort)="onSortBy($event)"
                  appColumnSortable
                  class="font-weight-semibold"
                  sortable="scan_result_severity"
                  style="width: 100px">
                Severity&nbsp;
              </th>
              <th (sort)="onSortBy($event)"
                  appColumnSortable
                  class="font-weight-semibold"
                  sortable="execution_source"
                  style="width: 100px">
                Source&nbsp;
              </th>
              <th (sort)="onSortBy($event)"
                  appColumnSortable
                  class="font-weight-semibold text-center"
                  sortable="scan_high_results_count">
                High&nbsp;
              </th>
              <th (sort)="onSortBy($event)"
                  appColumnSortable
                  class="font-weight-semibold text-center"
                  sortable="scan_medium_results_count">
                Medium&nbsp;
              </th>
              <th (sort)="onSortBy($event)"
                  appColumnSortable
                  class="font-weight-semibold text-center"
                  sortable="scan_low_results_count">
                Low&nbsp;
              </th>
              <th class="font-weight-semibold">
                Detail&nbsp;
              </th>
              <th class="font-weight-semibold text-center" style="width:8%">
                Action&nbsp;
              </th>
            </tr>
            </thead>
            <tbody [hidden]="tasks.length===0 && !loading">
            <tr *ngFor="let task of tasks">
              <td (click)="viewTaskResult(task)" class="cursor-pointer" style="width: 15%">
                <span class="text-blue-800">
                   {{task.taskName}}
                </span>
              </td>
              <td (click)="viewTaskResult(task)" class="text-center cursor-pointer" style="width: 15%">
                <app-vs-task-status [task]="task"></app-vs-task-status>
              </td>
              <td (click)="viewTaskResult(task)" class="cursor-pointer" style="width: 5%">
                <span *ngIf="task.taskCreationTime">
                   {{task.taskCreationTime|date:'short':'UTC'}}
                </span>
              </td>
              <td (click)="viewTaskResult(task)" class="cursor-pointer">
                <app-vs-severity [severity]="task.scanResultSeverity"></app-vs-severity>
              </td>
              <td (click)="viewTaskResult(task)" class="cursor-pointer" style="width: 15%">
                <span class="text-blue-800">
                   {{task.server.serverName }}
                </span>
              </td>
              <td (click)="viewTaskResult(task)" class="text-center">
                <span class="text-danger-300 font-size-lg">
                    {{(task.scanHighResultsCount ? task.scanHighResultsCount : 0) | thousandSuff}}
                </span>
              </td>
              <td (click)="viewTaskResult(task)" class="text-center">
                <span class="text-orange-300 font-size-lg">
                    {{(task.scanMediumResultsCount ? task.scanMediumResultsCount : 0) | thousandSuff}}
                  </span>
              </td>
              <td (click)="viewTaskResult(task)" class="text-center">
                <span class="text-info-300 font-size-lg">
                    {{(task.scanLowResultsCount ? task.scanLowResultsCount : 0) | thousandSuff}}
                  </span>
              </td>
              <td (click)="viewDetailTask(task)">
                <span class="text-primary cursor-pointer">View detail</span>
              </td>
              <td>
                <div class="d-flex justify-content-center align-items-center medium-icon">

                  <i (click)="stopTask(task)"
                     *ngIf="task.taskStatus===taskStatusEnum.RUNNING"
                     [ngClass]="processing.includes(task.taskUuid)?'icon-spinner2 spinner':'icon-stop2'"
                     class="cursor-pointer text-danger-800"
                     ngbTooltip="Stop task"
                     tooltipClass="utm-tooltip-top"></i>
                  <app-vs-task-result-export *ngIf="task.taskStatus===taskStatusEnum.DONE"
                                             [basic]="false"
                                             [buttonTye]="'icon'"
                                             [taskUUid]="task.taskUuid"
                  ></app-vs-task-result-export>

                </div>
              </td>
            </tr>
            </tbody>
            <tbody *ngIf="(tasks && tasks.length === 0 && !loading)">
            <tr>
              <td colspan="10">
                <app-no-data-found></app-no-data-found>
              </td>
            </tr>
            </tbody>
            <tbody *ngIf="loading">
            <tr>
              <td colspan="10">
                <div class="p-5 d-flex  justify-content-center align-items-center text-blue-800">
                  <app-utm-spinner [height]="'35px'"
                                   [label]="'Loading tasks'"
                                   [loading]="loading"
                                   [width]="'35px'">
                  </app-utm-spinner>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="tasks && tasks.length>0" class="mb-4">
          <div class="row justify-content-center">
            <ngb-pagination
              (pageChange)="loadPage($event)"
              [boundaryLinks]="true"
              [collectionSize]="totalItems"
              [maxSize]="5"
              [pageSize]="request.size"
              [rotate]="true"
              [size]="'sm'"></ngb-pagination>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div *ngIf="viewDetail" class="utm-right-container">
  <div (click)="viewDetail= undefined" class="overlay overlay-lg col-md-7"></div>
  <div class="card utm-right-action utm-right-action-lg">
    <div class="title d-flex justify-content-between  align-items-center border-bottom-1
     border-bottom-grey-100  pl-3 pt-3 pr-3 pb-0">
      <h6 class="card-title text-blue-800 font-weight-light">
        {{viewDetail.taskName}}
      </h6>
      <button (click)="viewDetail= undefined" aria-label="Close"
              class="close button-close" type="button">
        <div class="close-icon"></div>
      </button>
    </div>
    <app-vs-task-detail [task]="viewDetail"></app-vs-task-detail>
  </div>
</div>

